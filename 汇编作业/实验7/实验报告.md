# 汇编语言与逆向技术实验报告

# Lab7 - CTF (Capture The Flag)

<center><b>学号：</b>1911590   <b>姓名：</b>周安琪 <b>专业：</b>计算机科学与技术</center>

## 实验内容

1. 熟悉静态反汇编工具IDA Freeware；
2. 掌握对二进制代码内部逻辑关系的分析；
3. 掌握对二进制代码的修改和保存。

## 逆向分析

### 初步了解

首先稍微玩了一下游戏，应该是有几个关卡，每个关卡需要把里面的怪物都清空，然后才能进入下一个关卡。需要的flag应该在最后一关。

### 入口

用ida反编译入口main函数，找到mainloop()函数，应该就是游戏程序的主循环。可以看到，当这个函数的返回值不是二的时候，循环会结束。

![image-20221205180049743](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205180049743.png)

### mainloop

mainloop中解密成功的输出在比较显眼的位置。

![image-20221205180746033](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205180746033.png)

考察附近的变量，结合给出的结束画面，生成最终key的函数应该是`KEY::FINAL_DECRYPT((KEY *)v200);`，这个函数重新给v200赋值，并且成为最终的key。

<img src="C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205181447923.png" alt="image-20221205181447923" style="zoom:50%;" />

不过这一段伪代码实在是太抽象了，看不懂，所以先尝试直接修改分支通关。

mainloop也给出了其他操作的响应，在此先不关心。

## 代码修改

### 尝试直接跳到结局

#### 尝试

进入congratulation的跳转指令在这里：

![image-20221205191140683](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205191140683.png)

把jz改成jnz。

再上面的分支在这里：

![image-20221205191257769](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205191257769-16702387781291.png)

也改成jnz

保存，重来。结果游戏确实是结束了，但是没有显示flag。

#### 失败原因分析

我又仔细看了一下mainloop的逻辑，发现有一个writekey的操作，也就是说，需要四关都通过才可以拿到真正的key，每过一关就可以拿到1/4的内容。也就是说直接跳到最后是不可行的。

结束时：

![image-20221205213548969](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205213548969.png)

第1,2,3关：

![image-20221205213409482](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205213409482.png)

### 修改游戏属性

拥有无限红和蓝的时候可以轻松过关，所以考虑在遭受伤害和放大招的时候不扣红和蓝。

在mainloop中的data_init中看到，红应该是HP，蓝则是bullets。在涉及这两项的扣除操作的时候，将扣除的值改为0.

#### 蓝

扣蓝在这里：

![image-20221205214008260](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205214008260.png)

修改指令使得在放大招的时候不扣蓝。

![image-20221205215159216](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205215159216.png)

==注意！！==x86是复杂指令集，指令不等宽，在修改的时候很容易出问题……

如图所示我本来是直接想修改`00407f6f`那条sub指令的，想把第二个参数变成零，但是我改了之后出现了一些问题。原因是把参数改掉的话，这条指令的长度会发生变化，会覆盖掉后面有用的指令。所以最后前移了被减数为0的设定。

![image-20221205222024202](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205222024202.png)

这一步做完之后我打开游戏观察了一下，确实放大招不会扣蓝。

#### 红

扣红在这里：

![image-20221205214205217](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205214205217.png)

![image-20221205222357622](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205222357622.png)

这里我尝试了一会儿一直想不到办法，主要是这里用到的一些指令也不是很常用。所以就直接带着无限蓝再试一次了。

### 直接修改通关条件

上面说到我修改游戏变为放大招不扣蓝，而在这个游戏中大招的伤害还是蛮高的，所以修改了这里之后，我预计就能够轻松过关了，但现实上并不是这样。

我一路到了第四关，最后我杀光了图里的全部怪物，但是一直提示我没有杀够足够多的怪物，这应该是个坑。所以我干脆把“杀怪物个数”判断也删掉了。

下图是判断有没有杀够怪物的语句，把jz改成jmp（试过改成jnz结果在初始场景就过不去）。

![image-20221205225654887](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/image-20221205225654887.png)

可以直接走到界面最上方通关。

## 最终结果

最终结果其实不是在这里，而是在一片沙滩上。但是因为我不想看文案给按过去了……所以放完片尾之后，就直接回到了主界面。

我在主界面打算重来一次，就显示出了这个：

![1](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/1-16702533373241.jpg)

![img](C:/Users/16834/Desktop/notebook4/%E6%B1%87%E7%BC%96%E4%BD%9C%E4%B8%9A/%E5%AE%9E%E9%AA%8C7/1%5BAQMMGO2YWFL3SKYF2P8%7DW.png)

## 实验心得

通过这次实验，熟练了ida pro的使用，加强了反汇编知识的掌握。